steps:
  # Build the container image for test
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'test_runner', '.']
    env:
      - "DOCKER_BUILDKIT=1"

  # test
  - name: 'test_runner'
    args: ['python', '-m', 'pytest']

  # Install Poetry within the Docker container
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - 'pip install poetry && poetry install'

  # Install dependencies using Poetry
  - name: python
    entrypoint: poetry
    args: ["install", "--no-interaction", "--no-ansi"]

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'us-central1-docker.pkg.dev/percentpassed/percent/percent-app:$SHORT_SHA'
      - '.'

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'us-central1-docker.pkg.dev/percentpassed/percent/percent-app:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'run'
      - 'deploy'
      - 'percent-app'
      - '--image'
      - 'us-central1-docker.pkg.dev/percentpassed/percent/percent-app:$SHORT_SHA'
      - '--region'
      - 'us-central1'
      - '--update-secrets'
      - 'DB_USER=db_user:latest,DB_PASS=db_pass:latest,DB_PORT=db_port:latest,DB_NAME=db_name:latest,SECRET_KEY=secret_key:latest,ALGORITHM=algorithm:latest,ACCESS_TOKEN_EXPIRE_MINUTES=access_token_expire_minutes:latest,ADMIN_USERNAME=admin_username:latest,ADMIN_PASS=admin_pass:latest,ADMIN_EMAIL=admin_email:latest,DB_CLOUD=db_cloud:latest'
      - '--add-cloudsql-instances'
      - 'percentpassed:us-central1:percent'
      - '--port'
      - '8000'
